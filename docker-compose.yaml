# version: '3.8'

services:
  # # 1. Authentication Gateway: oauth2-proxy
  # oauth2-proxy:
  #   image: quay.io/oauth2-proxy/oauth2-proxy:latest
  #   container_name: oauth2-proxy
  #   restart: unless-stopped
  #   ports:
  #     - "4180:4180" # Exposed port for the reverse proxy to talk to
  #   environment:
  #     # --- CRITICAL CONFIGURATION AS CODE (CAC) ---
  #     # Secrets
  #     OAUTH2_PROXY_CLIENT_ID: "1046711721480-0ajbveaoseaumtqr6cqvt9hb5ibc6skm.apps.googleusercontent.com" # YOUR_GOOGLE_CLIENT_ID # From Google Console (CaC)
  #     OAUTH2_PROXY_CLIENT_SECRET: "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" # YOUR_GOOGLE_CLIENT_SECRET # From Google Console (CaC)
  #     OAUTH2_PROXY_COOKIE_SECRET: "GNGaQJmWUexmwiJDLd6d2NLDNJ8rxcwJ7eCubb5USU0=" # GENERATE_A_32_BYTE_SECRET # Use a random base64 string (CaC)
      
  #     # Google Provider Configuration
  #     OAUTH2_PROXY_PROVIDER: google
  #     OAUTH2_PROXY_GOOGLE_ADMIN_EMAIL: chetan.soni@vretta.com # Admin email for group lookups (optional)
  #     # OAUTH2_PROXY_ALLOWED_EMAILS: "@yourdomain.com" # Restrict access to specific email domain (CaC)
      
  #     # Routing/Redirection
  #     OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
  #     OAUTH2_PROXY_REDIRECT_URL: http://auth.app.localtest.me/oauth2/callback # MUST match Google Console (CaC)
  #     OAUTH2_PROXY_UPSTREAMS: http://whoami:80 # The service to protect
  #     OAUTH2_PROXY_EMAIL_DOMAINS: "*" # Can be restricted to your domain
      
  #     # Headers (for the protected app)
  #     OAUTH2_PROXY_PASS_ACCESS_TOKEN: "false"
  #     OAUTH2_PROXY_SET_X_AUTH_REQUEST_HEADERS: "true"
      
  #   networks:
  #     - proxy_net
  #   # Omitted volumes as it's configured entirely via ENV

# 1. Authentication Gateway: oauth2-proxy
  oauth2-proxy:
    image: quay.io/oauth2-proxy/oauth2-proxy:latest
    container_name: oauth2-proxy
    restart: unless-stopped
    ports:
      - "4180:4180" # Exposed port for the reverse proxy to talk to
    environment:
      # Use 'google' as the provider name
      OAUTH2_PROXY_PROVIDER: google

      # --- CRITICAL CONFIGURATION AS CODE (CAC) ---
      # SECRETS (CHANGE THESE)
      OAUTH2_PROXY_CLIENT_ID: "1046711721480-0ajbveaoseaumtqr6cqvt9hb5ibc6skm.apps.googleusercontent.com" # YOUR_GOOGLE_CLIENT_ID
      OAUTH2_PROXY_CLIENT_SECRET: "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" # YOUR_GOOGLE_CLIENT_SECRET
      OAUTH2_PROXY_COOKIE_SECRET: "GNGaQJmWUexmwiJDLd6d2NLDNJ8rxcwJ7eCubb5USU0=" # GENERATE_A_32_BYTE_SECRET # Use a random base64 string
      
      # ROUTING AND DOMAIN
      OAUTH2_PROXY_HTTP_ADDRESS: 0.0.0.0:4180
      OAUTH2_PROXY_REDIRECT_URL: http://auth.app.localtest.me:4180/oauth2/callback  # MUST match Google Console Client Redirect URI
      OAUTH2_PROXY_UPSTREAMS: http://whoami:80
      OAUTH2_PROXY_EMAIL_DOMAINS: "*" # Or "@yourdomain.com"
      
      # Headers (for the protected app)
      OAUTH2_PROXY_PASS_ACCESS_TOKEN: "false"
      OAUTH2_PROXY_SET_X_AUTH_REQUEST_HEADERS: "true"
      
      # IMPORTANT: Set the root domain Authelia will protect
      OAUTH2_PROXY_COOKIE_DOMAIN: localtest.me
      OAUTH2_PROXY_COOKIE_SECURE: "false" # Set to "true" if using HTTPS
      
    networks:
      - proxy_net

  # 2. Protected Application (Test)
  whoami:
    image: traefik/whoami
    container_name: whoami
    ports:
      - "8080:80"
    networks:
      - proxy_net

  # 3. Reverse Proxy (Example: Nginx, Traefik, Caddy)
  # You would configure your reverse proxy to send traffic for the protected app
  # (e.g., app.localtest.me) to the oauth2-proxy container, which then handles auth.

networks:
  proxy_net:
    driver: bridge
